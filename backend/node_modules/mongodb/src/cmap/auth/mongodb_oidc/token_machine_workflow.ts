import * as fs from 'fs';

import { MongoAWSError } from '../../../error';
<<<<<<< HEAD
import type { OIDCCallbackFunction, OIDCResponse } from '../mongodb_oidc';
=======
import { type AccessToken, MachineWorkflow } from './machine_workflow';
import { type TokenCache } from './token_cache';
>>>>>>> e0c0e1e6d6b93eaf86b7db393a49f476ae26bd95

/** Error for when the token is missing in the environment. */
const TOKEN_MISSING_ERROR = 'OIDC_TOKEN_FILE must be set in the environment.';

/**
<<<<<<< HEAD
 * The callback function to be used in the automated callback workflow.
 * @param params - The OIDC callback parameters.
 * @returns The OIDC response.
 */
export const callback: OIDCCallbackFunction = async (): Promise<OIDCResponse> => {
  const tokenFile = process.env.OIDC_TOKEN_FILE;
  if (!tokenFile) {
    throw new MongoAWSError(TOKEN_MISSING_ERROR);
  }
  const token = await fs.promises.readFile(tokenFile, 'utf8');
  return { accessToken: token };
};
=======
 * Device workflow implementation for AWS.
 *
 * @internal
 */
export class TokenMachineWorkflow extends MachineWorkflow {
  /**
   * Instantiate the machine workflow.
   */
  constructor(cache: TokenCache) {
    super(cache);
  }

  /**
   * Get the token from the environment.
   */
  async getToken(): Promise<AccessToken> {
    const tokenFile = process.env.OIDC_TOKEN_FILE;
    if (!tokenFile) {
      throw new MongoAWSError(TOKEN_MISSING_ERROR);
    }
    const token = await fs.promises.readFile(tokenFile, 'utf8');
    return { access_token: token };
  }
}
>>>>>>> e0c0e1e6d6b93eaf86b7db393a49f476ae26bd95
